angular.module("fimex",["ionic","ngCookies","ngMessages","angular.filter","pascalprecht.translate","tmh.dynamicLocale","toaster","LocalForageModule","ionic.ion.imageCacheFactory","fimex.config","fimex.controllers","fimex.directives","fimex.filters","fimex.services","fimex.notes"]).run(["AppSettings","DataLoader","$ionicPlatform","$filter","$timeout","$interval","$log","toaster","$ionicLoading",function(e,t,a,r,o,n,i,c,l){function d(){l.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+r("translate")("LOADING_TEXT")}),t.get("products/categories?",1e3).then(function(t){e.change("wcCategories",t.data.product_categories),l.hide()},function(e){i.error("error",e),l.hide()})}if(a.ready(function(){function e(){o(function(){c.pop({type:"error",body:r("translate")("INTERNET_CONNECTION_NONE"),toasterId:1})},0)}cordova.plugins.Keyboard.disableScroll(!0),window.StatusBar&&!ionic.Platform.isAndroid()&&StatusBar.styleLightContent(),document.addEventListener("offline",e,!1)}),n(function(){0==e.get("wcCategories").length&&d()},5e3),ionic.Platform.isAndroid()){var s=!1;a.registerBackButtonAction(function(e){return e.preventDefault(),s?ionic.Platform.exitApp():(s=!0,o(function(){c.pop({type:"error",body:r("translate")("CONFIRM_BEFORE_APP_EXIT"),toasterId:1})},0),o(function(){s=!1},5e3)),!1},101)}}]).config(["$httpProvider","$ionicConfigProvider","tmhDynamicLocaleProvider","$translateProvider","$localForageProvider","$stateProvider","$urlRouterProvider",function(e,t,a,r,o,n,i){e.defaults.useXDomain=!0,t.tabs.position("bottom"),a.localeLocationPattern("locales/angular-locale_{{locale}}.js"),r.useStaticFilesLoader({prefix:"i18n/",suffix:".json"}).registerAvailableLanguageKeys(["ar","de","en","es","fr","pt","ru"],{ar:"ar","ar_*":"ar",de:"de","de_*":"de",en:"en","en_*":"en",es:"es","es_*":"es",fr:"fr","fr_*":"fr",pt:"pt","pt_*":"pt",ru:"ru","ru_*":"ru",zh:"zh","zh_*":"zh"}).preferredLanguage("en").fallbackLanguage(["en","de","es","ru"]).determinePreferredLanguage().useSanitizeValueStrategy("escapeParameters").useLocalStorage(),o.config({name:"FIMEXProductCategory",storeName:"prefProducts",description:"Let user to keep their preference on FIMEX product(s) on mobile."}),n.state("tab",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html"}).state("tab.dash",{url:"/dash",cache:!0,views:{"tab-dash":{templateUrl:"templates/tab-dash.html",controller:"DashCtrl"}}}).state("tab.categories",{url:"/categories/{categoryLevel}/{categoryId}/{categorySlug}/{categoryName:.*}",cache:!0,views:{"tab-categories":{templateUrl:function(e){return"3"==e.categoryLevel?"templates/categories-products.html":"templates/tab-categories.html"},controller:"CategoriesCtrl"}}}).state("tab.search",{url:"/search",cache:!1,views:{"tab-search":{templateUrl:"templates/tab-search.html",controller:"SearchCtrl"}}}).state("tab.bookmarks",{url:"/bookmarks",cache:!1,views:{"tab-bookmarks":{templateUrl:"templates/tab-bookmarks.html",controller:"BookmarksCtrl"}}}).state("tab.settings",{url:"/settings",views:{"tab-settings":{templateUrl:"templates/tab-settings.html",controller:"SettingsCtrl"}}}),i.otherwise("/tab/dash")}]),angular.module("fimex.config",[]).constant("AppConfig",{appName:"FIMEX PRODUCT CATEGORIES",domainURI:"https://beta.fimex.com.tw/",wcAPIURI:"wc-api/v3/",wcAPIKey:"ck_e3d52fbb954e57758cc7ea5bdadb6d44d9fd8be3",wcAPISecret:"cs_894c2f79bd330af5eba70473c6a921593139f034",wcAPIURIsuffix:"filter[orderby]=id&filter[order]=ASC&filter[limit]=",wcAPIRSlimit:10,wcConnectTimeout:5e3,mgAPIName:"api",mgServiceKey:"key-0c16845e030f782c3acb501cdf07b8a2",mgAPIURI:"https://api.mailgun.net/v3/mg.fimex.com.tw/messages",contactForm2Email:"yannicklin@twoudia.com",contactForm2User:"Support",enquiryForm2Email:"christinechou@twoudia.com",enquiryForm2User:"Sales",enquiryCaption:"Product Enquiry List",mgConnectTimeout:1e4,oriCategories:[{id:9,name:"Electrical Materials",slug:"electrical-materials",parent:0,description:"",display:"default",image:"",count:0,sublevels:2},{id:10,name:"Electrical Materials - American Category",slug:"electrical-materials-aa",parent:0,description:"",display:"default",image:"",count:0,sublevels:2},{id:11,name:"Wiring Devices",slug:"wiring-devices",parent:0,description:"",display:"default",image:"",count:0,sublevels:3}]}),angular.module("fimex.services",[]).factory("ImagesCaching",["$ImageCacheFactory",function(e){return{Store:function(t,a){for(var r=[],o=0;o<t.length;o++)r.push(t[o][a]);e.Cache(r)}}}]).factory("DataLoader",["AppSettings","$http",function(e,t){return{get:function(a,r){var o=t({method:"GET",url:e.getURI(a,r)+"&consumer_key="+e.get("wcAPIKey")+"&consumer_secret="+e.get("wcAPISecret"),timeout:e.get("wcConnectTimeout")});return o}}}]).factory("PHPJSfunc",function(){return{urlencode:function(e){e=(e+"").toString();var t=encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+");return t}}}).factory("EmailSender",["AppSettings","$http","$log","toaster","$filter",function(e,t,a,r,o){return{send:function(n,i){return t({method:"POST",url:e.get("mgAPIURI"),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8",Authorization:"Basic "+e.getAuthPhrase(e.get("mgAPIName"),e.get("mgServiceKey"))},transformRequest:function(e){var t=[];for(var a in e)e[a].length>0&&t.push(encodeURIComponent(a)+"="+encodeURIComponent(e[a]));return t.join("&")},data:n,timeout:e.get("mgConnectTimeout")}).then(function(){r.pop({type:"info",body:o("translate")("ALERT_MAIL_SENT",{name:i}),toasterId:2})},function(){a.debug("error sending email.")}),null}}}]).factory("AppSettings",["AppConfig","$translate","tmhDynamicLocale",function(e,t,a){function r(e){switch(e){case"en":o.languageURI="";break;case"zh":o.languageURI="zh-hant/";break;default:o.languageURI=e+"/"}}var o=e;return o.wcCategories=[],o.curCategoriesLv="",o.language=t.use(),r(o.language),{change:function(e,n){o[e]=n,"language"==e&&(r(n),t.use(n),a.set(n))},get:function(e){return o[e]},getURI:function(e,t){return o.languageURI="",t=0==t?o.wcAPIRSlimit:t,e?o.domainURI+o.languageURI+o.wcAPIURI+e+o.wcAPIURIsuffix+t:o.domainURI+o.languageURI+o.wcAPIURI+"?"+o.wcAPIURIsuffix+t},getAuthPhrase:function(e,t){return btoa(e+":"+t)}}}]).service("BookMarks",["$localForage","$log",function(e,t){var a=e.instance();return{countos:function(){return a.length().then(function(e){return t.debug(e),e})},count:function(){return a.length()},check:function(e){return a.getItem(e)},add:function(e,r){a.setItem(e,{name:r.title,id:r.id,thumbnail:r.featured_src,category:r.categories[0],path:r.permalink}).then(function(){t.debug("LocalForage Add #:"+e)})},drop:function(e){a.removeItem(e).then(function(){t.debug("LocalForage Remove #:"+e)})},getall:function(){var e=[];return a.iterate(function(t,a){e.push(t)}).then(function(){}),e},reset:function(){return a.clear()}}}]).service("ModalHandler_product",["BookMarks","ImagesCaching","$ionicModal","$filter","$ionicSlideBoxDelegate","$ionicScrollDelegate",function(e,t,a,r,o,n){return{init:function(i){a.fromTemplateUrl("templates/product-modal.html",{scope:i,animation:"slide-in-up"}).then(function(e){i.modal=e,i.detail=null,i.detailImg=null}),i.openModal=function(a){i.detail=a,i.detailImg=r("unique")(i.detail.images,"src"),e.check(a.id).then(function(e){i.detail.bookmarked=angular.isObject(e)?!0:!1}),o.update(),i.modal.show(),n.scrollTop(),t.Store(i.detailImg,"src")},i.closeModal=function(){i.modal.hide()},i.$on("$destroy",function(){i.modal.remove()}),i.triggerBookmark=function(t){e.check(t.id).then(function(a){angular.isObject(a)?e.drop(t.id):e.add(t.id,t)}),i.detail.bookmarked=!i.detail.bookmarked,i.closeModal()}}}}]).service("ModalHandler_enquiry",["AppSettings","BookMarks","EmailSender","$ionicModal","$filter","$ionicScrollDelegate",function(e,t,a,r,o,n){return{init:function(i){i.forms={},i.enForm={},r.fromTemplateUrl("templates/enquiry-modal.html",{scope:i,animation:"slide-in-up"}).then(function(e){i.modal=e,i.modal.show(),n.scrollTop()}),i.closeModal=function(){i.modal.hide()},i.$on("$destroy",function(){i.modal.remove()}),i.sendEnquiry=function(){var r=BMCollect_TEXT="";angular.forEach(i.bookmarks,function(e){r+=r?"</tr><tr>":"<tr>",BMCollect_TEXT+=BMCollect_TEXT?" ;":"",r=r+'<td style="border: 1px dashed black; padding: 5px;">name</td><td style="border: 1px dashed black; padding: 5px;">'+e.name+'</td><td style="border: 1px dashed black; padding: 5px;">category</td><td style="border: 1px dashed black; padding: 5px;">'+e.category+'</td><td style="border: 1px dashed black; padding: 5px;">path</td><td style="border: 1px dashed black; padding: 5px;">'+e.path+"</td>",BMCollect_TEXT=BMCollect_TEXT+"name:"+e.name+" , category:"+e.category+" , path:"+e.path+" "});var n={from:i.enForm.enName+" <"+i.enForm.enEmail+">",to:e.get("enquiryForm2User")+" <"+e.get("enquiryForm2Email")+">",cc:"",bcc:"",subject:"Enquiry sent via Mobile APP - "+e.get("appName")+", "+o("date")(Date.now(),"yyyy-MM-dd HH:mm Z"),html:'<table style="border: 1px dashed black; border-collapse: collapse;"><caption>'+e.get("appName")+'</caption><tfoot style="color: red;"><tr><td style="border: 1px dashed black; padding: 5px;">Time</td><td style="border: 1px dashed black; padding: 5px;">'+o("date")(Date.now(),"yyyy-MM-dd HH:mm Z")+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">SPEC</td><td style="border: 1px dashed black; padding: 5px;">Platform: '+device.platform+", Version: "+device.version+", Manufacturer: "+device.manufacturer+", Model: "+device.model+", UUID: "+device.uuid+'</td></tr></tfoot><tbody><tr><td style="border: 1px dashed black; padding: 5px;">Name</td><td style="border: 1px dashed black; padding: 5px;">'+i.enForm.enName+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Email</td><td style="border: 1px dashed black; padding: 5px;">'+i.enForm.enEmail+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Message</td><td style="border: 1px dashed black; padding: 5px;">'+i.enForm.enMessage+'</td></tr></tbody></table><br /><table style="border: 1px dashed black; border-collapse: collapse;"><caption>'+e.get("enquiryCaption")+"</caption>"+r+"</tr></table>",text:"TEXT VERSION >> Notes: "+i.enForm.enMessage+", Products: "+BMCollect_TEXT};a.send(n,i.enForm.enName),i.enForm={},i.forms.enquiryForm.$setPristine(),t.reset().then(function(){i.RSempty=!0,i.bookmarks=null,i.RScount=0,i.closeModal()})}}}}]),angular.module("fimex.controllers",[]).controller("DashCtrl",["Notes","$scope","$filter",function(e,t,a){var r=e.all();t.notesNormal=a("filter")(r,{top:0}),t.notesTop=a("filter")(r,{top:1}),t.notesCount=r.length,t.today=new Date}]).controller("CategoriesCtrl",["AppSettings","DataLoader","ImagesCaching","ModalHandler_product","$scope","$stateParams","$log","$filter","$ionicLoading",function(e,t,a,r,o,n,i,c,l){l.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+c("translate")("LOADING_TEXT")}),o.RSempty=!1;var d=1;o.able2Loadmore=0;var s=" >> ";o.RSitemURI="#/tab/categories/"+(parseInt(n.categoryLevel)+1);var u=e.get("curCategoriesLv"),p=u.split(s,2);switch(o.showCount=0,parseInt(n.categoryLevel)){case 0:o.loadResult=function(){o.categories=e.get("oriCategories"),l.hide()};break;case 3:o.loadResult=function(){t.get("products?filter[category]="+n.categorySlug+"&",0).then(function(t){0==t.data.products.length?(o.products=null,o.RSempty=!0):(o.products=t.data.products,t.data.products.length==e.get("wcAPIRSlimit")&&(d++,o.able2Loadmore=1),a.Store(o.products,"featured_src")),l.hide()},function(e){i.error("error",e),l.hide(),o.RSempty=!0})},u=p[0]+s+p[1];break;case 2:o.showCount=1;default:o.loadResult=function(){o.categories=c("filter")(e.get("wcCategories"),{parent:parseInt(n.categoryId)},!0),0==o.categories.length&&(o.categories=null,o.RSempty=!0),l.hide()},u=parseInt(n.categoryLevel)>1?p[0]:""}0==parseInt(n.categoryLevel)?(o.titleSub="",e.change("curCategoriesLv","")):(o.titleSub=""==u?c("unescapeHTML")(n.categoryName):u+s+c("unescapeHTML")(n.categoryName),e.change("curCategoriesLv",o.titleSub)),o.loadResult(),o.loadMore=function(){l.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+c("translate")("LOADING_MORE_TEXT")}),o.able2Loadmore=0,t.get("products?filter[category]="+n.categorySlug+"&page="+d,0).then(function(t){t.data.products.length>0&&(o.products=o.products.concat(t.data.products),t.data.products.length==e.get("wcAPIRSlimit")&&(d++,o.able2Loadmore=1),a.Store(o.products,"featured_src")),l.hide(),o.$broadcast("scroll.infiniteScrollComplete")},function(e){i.error("error",e),l.hide(),o.$broadcast("scroll.infiniteScrollComplete")})},r.init(o)}]).controller("SearchCtrl",["AppSettings","ModalHandler_product","PHPJSfunc","DataLoader","ImagesCaching","$scope","$log","$filter","$ionicLoading",function(e,t,a,r,o,n,i,c,l){n.search={};var d=1;n.able2Loadmore=0,n.cleanResult=function(){n.products=null,n.RSempty=!1},n.cleanSearch=function(){n.search.term="",n.cleanResult()},n.doSearch=function(){n.search.term&&(cordova.plugins.Keyboard.close(),n.loadResult())},n.loadResult=function(){l.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+c("translate")("LOADING_TEXT")}),n.cleanResult(),r.get("products?filter[q]="+a.urlencode(n.search.term)+"&",0).then(function(t){0==t.data.products.length?(n.products=null,n.RSempty=!0):(n.products=t.data.products,t.data.products.length==e.get("wcAPIRSlimit")&&(d++,n.able2Loadmore=1),o.Store(n.products,"featured_src")),l.hide()},function(e){i.error("error",e),l.hide(),n.RSempty=!0})},n.loadMore=function(){l.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+c("translate")("LOADING_MORE_TEXT")}),n.able2Loadmore=0,r.get("products?filter[q]="+a.urlencode(n.search.term)+"&page="+d,0).then(function(t){t.data.products.length>0&&(n.products=n.products.concat(t.data.products),t.data.products.length==e.get("wcAPIRSlimit")&&(d++,n.able2Loadmore=1),o.Store(n.products,"featured_src")),l.hide(),n.$broadcast("scroll.infiniteScrollComplete")},function(e){i.error("error",e),l.hide(),n.$broadcast("scroll.infiniteScrollComplete")})},t.init(n)}]).controller("BookmarksCtrl",["BookMarks","ModalHandler_enquiry","$scope","$state","$ionicPopup","$filter",function(e,t,a,r,o,n){a.RSempty=!1,a.bookmarks=null,a.RScount=0,e.count().then(function(t){t>0?(a.RScount=t,a.bookmarks=e.getall()):a.RSempty=!0}),a.gotoSearch=function(){r.go("tab.search")},a.openEnquiry=function(){t.init(a)},a.dropBookmark=function(t){var r=o.confirm({title:n("translate")("POPUP_DROPBOOKMARK_CONFIRM_TITLE"),template:n("translate")("POPUP_DROPBOOKMARK_CONFIRM_TEMPLATE"),cancelType:"button-light",okType:"button-assertive"});r.then(function(r){r&&(e.drop(t.id),a.RScount--,a.bookmarks=e.getall())})}}]).controller("SettingsCtrl",["AppSettings","EmailSender","$scope","$ionicHistory","$translate","$filter",function(e,t,a,r,o,n){a.forms={},a.ctForm={},a.settings={language:o.use()},a.$watch("settings.language",function(){a.settings.language!=e.get("language")&&(e.change("language",a.settings.language),r.clearCache(),r.clearHistory(),e.change("wcCategories",[]))}),a.formSubmit=function(){var r={from:a.ctForm.ctName+" <"+a.ctForm.ctEmail+">",to:e.get("contactForm2User")+" <"+e.get("contactForm2Email")+">",cc:"",bcc:"",subject:"Message sent via Mobile APP - "+e.get("appName")+", "+n("date")(Date.now(),"yyyy-MM-dd HH:mm Z"),html:'<table style="border: 1px dashed black; border-collapse: collapse;"><caption>'+e.get("appName")+'</caption><tfoot style="color: red;"><tr><td style="border: 1px dashed black; padding: 5px;">Time</td><td style="border: 1px dashed black; padding: 5px;">'+n("date")(Date.now(),"yyyy-MM-dd HH:mm Z")+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">SPEC</td><td style="border: 1px dashed black; padding: 5px;">Platform: '+device.platform+", Version: "+device.version+", Manufacturer: "+device.manufacturer+", Model: "+device.model+", UUID: "+device.uuid+'</td></tr></tfoot><tbody><tr><td style="border: 1px dashed black; padding: 5px;">Name</td><td style="border: 1px dashed black; padding: 5px;">'+a.ctForm.ctName+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Email</td><td style="border: 1px dashed black; padding: 5px;">'+a.ctForm.ctEmail+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Message</td><td style="border: 1px dashed black; padding: 5px;">'+a.ctForm.ctMessage+"</td></tr></tbody></table>",text:"TEXT VERSION: "+a.ctForm.ctMessage};t.send(r,a.ctForm.ctName),a.ctForm={},a.forms.contactForm.$setPristine()}}]),angular.module("fimex.directives",[]).directive("gpRadio",function(){return{restrict:"AE",require:"ngModel",scope:{model:"=ngModel",value:"=gpRadio"},link:function(e,t,a,r){t.addClass("button"),t.on("click",function(t){e.$apply(function(){r.$setViewValue(e.value)})}),e.$watch("model",function(a){t.removeClass("button-positive"),a===e.value&&t.addClass("button-positive")})}}}).directive("keyInput",function(){return function(e,t,a){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(a.keyInput)}),t.preventDefault())})}}).directive("keyboardHide",function(){return{restrict:"A",link:function(e,t,a){e.$watch("native.keyboardshow",function(){t.addClass("hide")}),e.$watch("native.keyboardhide",function(){t.removeClass("hide")})}}}),angular.module("fimex.filters",[]).filter("partRemove",["$sce",function(e){return function(t,a){var r=document.createElement("div");r.innerHTML=t;for(var o=r.getElementsByTagName(a),n=o.length;n>0;n--)o[n-1].parentNode.removeChild(o[n-1]);return e.trustAsHtml(r.outerHTML)}}]).filter("unicode",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("unescapeHTML",function(){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return function(t){return angular.forEach(e,function(e,a){t=String(t).replace(new RegExp(e,"gi"),a)}),t}}),angular.module("fimex.notes",[]).factory("Notes",function(){var e=[{id:0,top:0,title:"NOTES_20160107_TITLE",content:"NOTES_20160107_CONTENT"},{id:1,top:0,title:"NOTES_20160108_TITLE",content:"NOTES_20160108_CONTENT"},{id:2,top:1,title:"NOTES_20160109_TITLE",content:"NOTES_20160109_CONTENT"},{id:3,top:0,title:"NOTES_20160211_TITLE",content:"NOTES_20160211_CONTENT"}];return{all:function(){return e},get:function(t){for(var a=0;a<e.length;a++)if(e[a].id===parseInt(t))return e[a];return null}}});