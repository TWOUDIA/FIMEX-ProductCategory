angular.module("fimex",["ionic","ngCookies","ngMessages","angular.filter","pascalprecht.translate","tmh.dynamicLocale","toaster","LocalForageModule","ionic.ion.imageCacheFactory","fimex.config","fimex.controllers","fimex.directives","fimex.filters","fimex.services","fimex.notes"]).run(["AppSettings","DataLoader","$ionicPlatform","$filter","$timeout","$interval","$log","toaster","$ionicLoading","$rootScope",function(e,t,a,n,o,r,i,c,l,s){function d(){l.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+n("translate")("LOADING_TEXT")}),t.get("products/categories?",1e3).then(function(t){e.change("wcCategories",t.data.product_categories),l.hide()},function(e){i.error("error",e),l.hide(),s.connectionFails++})}if(a.ready(function(){cordova.plugins.Keyboard.disableScroll(!0),window.StatusBar&&!ionic.Platform.isAndroid()&&StatusBar.styleLightContent(),void 0!==typeof analytics?(analytics.startTrackerWithId("UA-46856632-4"),analytics.setUserId(device.uuid)):(console.log("Google Analytics Unavailable"),$rootscope.connectionFails++)}),s.connectionFails=0,r(function(){s.connectionFails>1&&(l.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+n("translate")("INTERNET_CONNECTION_NONE")}),o(function(){l.hide(),s.connectionFails=0},5e3))},1e4),r(function(){0==e.get("wcCategories").length&&d()},5e3),ionic.Platform.isAndroid()){var u=!1;a.registerBackButtonAction(function(e){return e.preventDefault(),u?ionic.Platform.exitApp():(u=!0,o(function(){c.pop({type:"error",body:n("translate")("CONFIRM_BEFORE_APP_EXIT"),toasterId:1})},0),o(function(){u=!1},5e3)),!1},101)}}]).config(["$httpProvider","$ionicConfigProvider","tmhDynamicLocaleProvider","$translateProvider","$localForageProvider","$stateProvider","$urlRouterProvider",function(e,t,a,n,o,r,i){e.defaults.useXDomain=!0,t.tabs.position("bottom"),a.localeLocationPattern("locales/angular-locale_{{locale}}.js"),n.useStaticFilesLoader({prefix:"i18n/",suffix:".json"}).registerAvailableLanguageKeys(["de","en","es","ru"],{de:"de","de_*":"de",en:"en","en_*":"en",es:"es","es_*":"es",ru:"ru","ru_*":"ru"}).preferredLanguage("en").determinePreferredLanguage().useSanitizeValueStrategy("escapeParameters").useLocalStorage(),o.config({name:"FIMEXProductCategory",storeName:"prefProducts",description:"Let user to keep their preference on FIMEX product(s) on mobile."}),r.state("tab",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html"}).state("tab.dash",{url:"/dash",cache:!0,views:{"tab-dash":{templateUrl:"templates/tab-dash.html",controller:"DashCtrl"}}}).state("tab.categories",{url:"/categories/{categoryLevel}/{categoryId}/{categorySlug}/{categoryName:.*}",cache:!0,views:{"tab-categories":{templateUrl:function(e){return"3"==e.categoryLevel?"templates/categories-products.html":"templates/tab-categories.html"},controller:"CategoriesCtrl"}}}).state("tab.search",{url:"/search",cache:!1,views:{"tab-search":{templateUrl:"templates/tab-search.html",controller:"SearchCtrl"}}}).state("tab.bookmarks",{url:"/bookmarks",cache:!1,views:{"tab-bookmarks":{templateUrl:"templates/tab-bookmarks.html",controller:"BookmarksCtrl"}}}).state("tab.settings",{url:"/settings",views:{"tab-settings":{templateUrl:"templates/tab-settings.html",controller:"SettingsCtrl"}}}),i.otherwise("/tab/dash")}]),angular.module("fimex.config",[]).constant("AppConfig",{appName:"FIMEX PRODUCT CATEGORIES",domainURI:"https://beta.fimex.com.tw/",wcAPIURI:"wc-api/v3/",wcAPIKey:"ck_e3d52fbb954e57758cc7ea5bdadb6d44d9fd8be3",wcAPISecret:"cs_894c2f79bd330af5eba70473c6a921593139f034",wcAPIURIsuffix:"filter[orderby]=id&filter[order]=ASC&filter[limit]=",wcAPIRSlimit:10,wcConnectTimeout:5e3,mgAPIName:"api",mgServiceKey:"key-0c16845e030f782c3acb501cdf07b8a2",mgAPIURI:"https://api.mailgun.net/v3/mg.fimex.com.tw/messages",contactForm2Email:"yannicklin@twoudia.com",contactForm2User:"Support",enquiryForm2Email:"christinechou@twoudia.com",enquiryForm2User:"Sales",enquiryCaption:"Product Enquiry List",mgConnectTimeout:1e4,oriCategories:[{id:9,name:"Electrical Materials",slug:"electrical-materials",parent:0,description:"",display:"default",image:"",count:0,sublevels:2},{id:10,name:"Electrical Materials - American Category",slug:"electrical-materials-aa",parent:0,description:"",display:"default",image:"",count:0,sublevels:2},{id:11,name:"Wiring Devices",slug:"wiring-devices",parent:0,description:"",display:"default",image:"",count:0,sublevels:3}]}),angular.module("fimex.services",[]).factory("ImagesCaching",["$ImageCacheFactory","$filter",function(e,t){return{Store:function(a,n,o){for(var r=[],i=0;i<a.length;i++){var c=""==o?a[i][n]:t(o)(a[i][n]);r.push(c)}e.Cache(r)}}}]).factory("DataLoader",["AppSettings","$http",function(e,t){return{get:function(a,n){var o=t({method:"GET",url:e.getURI(a,n)+"&consumer_key="+e.get("wcAPIKey")+"&consumer_secret="+e.get("wcAPISecret"),timeout:e.get("wcConnectTimeout")});return o}}}]).factory("PHPJSfunc",function(){return{urlencode:function(e){e=(e+"").toString();var t=encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+");return t}}}).factory("EmailSender",["AppSettings","$http","$log","toaster","$filter","$timeout",function(e,t,a,n,o,r){return{send:function(i,c){return t({method:"POST",url:e.get("mgAPIURI"),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8",Authorization:"Basic "+e.getAuthPhrase(e.get("mgAPIName"),e.get("mgServiceKey"))},transformRequest:function(e){var t=[];for(var a in e)e[a].length>0&&t.push(encodeURIComponent(a)+"="+encodeURIComponent(e[a]));return t.join("&")},data:i,timeout:e.get("mgConnectTimeout")}).then(function(){r(function(){n.pop({type:"info",body:o("translate")("ALERT_MAIL_SENT",{name:c}),toasterId:2})},0)},function(){a.debug("error sending email.")}),null}}}]).factory("AppSettings",["AppConfig","$translate","tmhDynamicLocale",function(e,t,a){function n(e){switch(e){case"en":o.languageURI="";break;default:o.languageURI=e+"/"}}var o=e;return o.wcCategories=[],o.curCategoriesLv="",o.language=t.use(),n(o.language),{change:function(e,r){o[e]=r,"language"==e&&(n(r),t.use(r),a.set(r))},get:function(e){return o[e]},getURI:function(e,t){return o.languageURI="",t=0==t?o.wcAPIRSlimit:t,e?o.domainURI+o.languageURI+o.wcAPIURI+e+o.wcAPIURIsuffix+t:o.domainURI+o.languageURI+o.wcAPIURI+"?"+o.wcAPIURIsuffix+t},getAuthPhrase:function(e,t){return btoa(e+":"+t)}}}]).service("BookMarks",["$localForage",function(e){var t=e.instance();return{count:function(){return t.length()},check:function(e){return t.getItem(e)},add:function(e,a){t.setItem(e,{name:a.title,id:a.id,thumbnail:a.featured_src,category:a.categories[0],path:a.permalink}).then(function(){void 0!==typeof analytics&&analytics.trackEvent("BookMarks","add")})},drop:function(e){t.removeItem(e).then(function(){void 0!==typeof analytics&&analytics.trackEvent("BookMarks","drop")})},getall:function(){var e=[];return t.iterate(function(t,a){e.push(t)}).then(function(){}),e},reset:function(){return t.clear()}}}]).service("ModalHandler_product",["BookMarks","ImagesCaching","$ionicModal","$filter","$ionicSlideBoxDelegate","$ionicScrollDelegate",function(e,t,a,n,o,r){return{init:function(i){a.fromTemplateUrl("templates/product-modal.html",{scope:i,animation:"slide-in-up"}).then(function(e){i.modal=e,i.detail=null,i.detailImg=null}),i.openModal=function(a){i.detail=a,i.detailImg=n("unique")(i.detail.images,"src"),e.check(a.id).then(function(e){i.detail.bookmarked=angular.isObject(e)?!0:!1}),o.update(),i.modal.show(),r.scrollTop(),t.Store(i.detailImg,"src","")},i.closeModal=function(){i.modal.hide()},i.$on("$destroy",function(){i.modal.remove()}),i.triggerBookmark=function(t){e.check(t.id).then(function(a){angular.isObject(a)?e.drop(t.id):e.add(t.id,t)}),i.detail.bookmarked=!i.detail.bookmarked,i.closeModal()}}}}]).service("ModalHandler_enquiry",["AppSettings","BookMarks","EmailSender","$ionicModal","$filter","$ionicScrollDelegate",function(e,t,a,n,o,r){return{init:function(i){i.forms={},i.enForm={},n.fromTemplateUrl("templates/enquiry-modal.html",{scope:i,animation:"slide-in-up"}).then(function(e){i.modal=e,i.modal.show(),r.scrollTop()}),i.closeModal=function(){i.modal.hide()},i.$on("$destroy",function(){i.modal.remove()}),i.sendEnquiry=function(){var n=BMCollect_TEXT="";angular.forEach(i.bookmarks,function(e){n+=n?"</tr><tr>":"<tr>",BMCollect_TEXT+=BMCollect_TEXT?" ;":"",n=n+'<td style="border: 1px dashed black; padding: 5px;">name</td><td style="border: 1px dashed black; padding: 5px;">'+e.name+'</td><td style="border: 1px dashed black; padding: 5px;">category</td><td style="border: 1px dashed black; padding: 5px;">'+e.category+'</td><td style="border: 1px dashed black; padding: 5px;">path</td><td style="border: 1px dashed black; padding: 5px;">'+e.path+"</td>",BMCollect_TEXT=BMCollect_TEXT+"name:"+e.name+" , category:"+e.category+" , path:"+e.path+" "});var r={from:i.enForm.enName+" <"+i.enForm.enEmail+">",to:e.get("enquiryForm2User")+" <"+e.get("enquiryForm2Email")+">",cc:"",bcc:"",subject:"Enquiry sent via Mobile APP - "+e.get("appName")+", "+o("date")(Date.now(),"yyyy-MM-dd HH:mm Z"),html:'<table style="border: 1px dashed black; border-collapse: collapse;"><caption>'+e.get("appName")+'</caption><tfoot style="color: red;"><tr><td style="border: 1px dashed black; padding: 5px;">Time</td><td style="border: 1px dashed black; padding: 5px;">'+o("date")(Date.now(),"yyyy-MM-dd HH:mm Z")+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">SPEC</td><td style="border: 1px dashed black; padding: 5px;">Platform: '+device.platform+", Version: "+device.version+", Manufacturer: "+device.manufacturer+", Model: "+device.model+", UUID: "+device.uuid+'</td></tr></tfoot><tbody><tr><td style="border: 1px dashed black; padding: 5px;">Name</td><td style="border: 1px dashed black; padding: 5px;">'+i.enForm.enName+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Email</td><td style="border: 1px dashed black; padding: 5px;">'+i.enForm.enEmail+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Message</td><td style="border: 1px dashed black; padding: 5px;">'+i.enForm.enMessage+'</td></tr></tbody></table><br /><table style="border: 1px dashed black; border-collapse: collapse;"><caption>'+e.get("enquiryCaption")+"</caption>"+n+"</tr></table>",text:"TEXT VERSION >> Notes: "+i.enForm.enMessage+", Products: "+BMCollect_TEXT};a.send(r,i.enForm.enName),i.enForm={},i.forms.enquiryForm.$setPristine(),t.reset().then(function(){i.RSempty=!0,i.bookmarks=null,i.RScount=0,i.closeModal()}),void 0!==typeof analytics&&analytics.trackEvent("Email","EnquiryfromBookMarks")}}}}]),angular.module("fimex.controllers",[]).controller("DashCtrl",["Notes","$scope","$filter",function(e,t,a){var n=e.all();t.notesNormal=a("filter")(n,{top:0}),t.notesTop=a("filter")(n,{top:1}),t.notesCount=n.length,t.today=new Date,void 0!==typeof analytics&&analytics.trackView("Dashboard")}]).controller("CategoriesCtrl",["AppSettings","DataLoader","ImagesCaching","ModalHandler_product","$rootScope","$scope","$stateParams","$log","$filter","$ionicLoading",function(e,t,a,n,o,r,i,c,l,s){s.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+l("translate")("LOADING_TEXT")}),r.RSempty=!1;var d=1;r.able2Loadmore=0,void 0!==typeof analytics&&analytics.trackView("Categories");var u=" >> ";r.RSitemURI="#/tab/categories/"+(parseInt(i.categoryLevel)+1);var p=e.get("curCategoriesLv"),m=p.split(u,2);switch(r.showCount=0,parseInt(i.categoryLevel)){case 0:r.loadResult=function(){r.categories=e.get("oriCategories"),s.hide()};break;case 3:r.loadResult=function(){t.get("products?filter[category]="+i.categorySlug+"&",0).then(function(t){0==t.data.products.length?(r.products=null,r.RSempty=!0):(r.products=t.data.products,t.data.products.length==e.get("wcAPIRSlimit")&&(d++,r.able2Loadmore=1),a.Store(r.products,"featured_src","WPthumbnailURI")),s.hide()},function(e){c.error("error",e),s.hide(),r.RSempty=!0,o.connectionFails++})},p=m[0]+u+m[1];break;case 2:r.showCount=1;default:r.loadResult=function(){r.categories=l("filter")(e.get("wcCategories"),{parent:parseInt(i.categoryId)},!0),0==r.categories.length&&(r.categories=null,r.RSempty=!0),s.hide()},p=parseInt(i.categoryLevel)>1?m[0]:""}0==parseInt(i.categoryLevel)?(r.titleSub="",e.change("curCategoriesLv","")):(r.titleSub=""==p?l("unescapeHTML")(i.categoryName):p+u+l("unescapeHTML")(i.categoryName),e.change("curCategoriesLv",r.titleSub)),r.loadResult(),r.loadMore=function(){s.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+l("translate")("LOADING_MORE_TEXT")}),r.able2Loadmore=0,t.get("products?filter[category]="+i.categorySlug+"&page="+d,0).then(function(t){t.data.products.length>0&&(r.products=r.products.concat(t.data.products),t.data.products.length==e.get("wcAPIRSlimit")&&(d++,r.able2Loadmore=1),a.Store(r.products,"featured_src","WPthumbnailURI")),s.hide(),r.$broadcast("scroll.infiniteScrollComplete")},function(e){c.error("error",e),s.hide(),o.connectionFails++})},n.init(r)}]).controller("SearchCtrl",["AppSettings","ModalHandler_product","PHPJSfunc","DataLoader","ImagesCaching","$rootScope","$scope","$log","$filter","$ionicLoading",function(e,t,a,n,o,r,i,c,l,s){i.search={};var d=1;i.able2Loadmore=0,void 0!==typeof analytics&&analytics.trackView("Search"),i.cleanResult=function(){i.products=null,i.RSempty=!1},i.cleanSearch=function(){i.search.term="",i.cleanResult(),void 0!==typeof analytics&&analytics.trackEvent("Search","resetSearch")},i.doSearch=function(){i.search.term&&(cordova.plugins.Keyboard.close(),i.loadResult(),void 0!==typeof analytics&&analytics.trackEvent("Search","doSearch",i.search.term))},i.loadResult=function(){s.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+l("translate")("LOADING_TEXT")}),i.cleanResult(),n.get("products?filter[q]="+a.urlencode(i.search.term)+"&",0).then(function(t){0==t.data.products.length?(i.products=null,i.RSempty=!0):(i.products=t.data.products,t.data.products.length==e.get("wcAPIRSlimit")&&(d++,i.able2Loadmore=1),o.Store(i.products,"featured_src","WPthumbnailURI")),s.hide()},function(e){c.error("error",e),s.hide(),i.RSempty=!0,r.connectionFails++})},i.loadMore=function(){s.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+l("translate")("LOADING_MORE_TEXT")}),i.able2Loadmore=0,n.get("products?filter[q]="+a.urlencode(i.search.term)+"&page="+d,0).then(function(t){t.data.products.length>0&&(i.products=i.products.concat(t.data.products),t.data.products.length==e.get("wcAPIRSlimit")&&(d++,i.able2Loadmore=1),o.Store(i.products,"featured_src","WPthumbnailURI")),s.hide(),i.$broadcast("scroll.infiniteScrollComplete")},function(e){c.error("error",e),s.hide(),r.connectionFails++})},t.init(i)}]).controller("BookmarksCtrl",["BookMarks","ModalHandler_enquiry","$scope","$state","$ionicPopup","$filter",function(e,t,a,n,o,r){a.RSempty=!1,a.bookmarks=null,a.RScount=0,void 0!==typeof analytics&&analytics.trackView("BookMarks"),e.count().then(function(t){t>0?(a.RScount=t,a.bookmarks=e.getall()):a.RSempty=!0}),a.gotoSearch=function(){n.go("tab.search")},a.openEnquiry=function(){t.init(a)},a.dropBookmark=function(t){var n=o.confirm({title:r("translate")("POPUP_DROPBOOKMARK_CONFIRM_TITLE"),template:r("translate")("POPUP_DROPBOOKMARK_CONFIRM_TEMPLATE"),cancelType:"button-light",okType:"button-assertive"});n.then(function(n){n&&(e.drop(t.id),a.RScount--,a.bookmarks=e.getall())})}}]).controller("SettingsCtrl",["AppSettings","EmailSender","$scope","$ionicHistory","$translate","$filter","$window",function(e,t,a,n,o,r,i){a.forms={},a.ctForm={},a.settings={language:o.use()},void 0!==typeof analytics&&analytics.trackView("Settings"),a.narrowformat=1,a.recalDimensions=function(){i.innerWidth<i.innerHeight||i.innerWidth<479?a.narrowformat=1:a.narrowformat=0,void 0!==typeof analytics&&analytics.trackEvent("Device","Orientation","toPortrait",a.narrowformat)},a.recalDimensions(),angular.element(i).bind("resize",function(){a.$apply(function(){a.recalDimensions()})}),a.$watch("settings.language",function(){a.settings.language!=e.get("language")&&(e.change("language",a.settings.language),n.clearCache(),n.clearHistory(),e.change("wcCategories",[]),void 0!==typeof analytics&&analytics.trackEvent("Interface","Language",a.settings.language))}),a.formSubmit=function(){var n={from:a.ctForm.ctName+" <"+a.ctForm.ctEmail+">",to:e.get("contactForm2User")+" <"+e.get("contactForm2Email")+">",cc:"",bcc:"",subject:"Message sent via Mobile APP - "+e.get("appName")+", "+r("date")(Date.now(),"yyyy-MM-dd HH:mm Z"),html:'<table style="border: 1px dashed black; border-collapse: collapse;"><caption>'+e.get("appName")+'</caption><tfoot style="color: red;"><tr><td style="border: 1px dashed black; padding: 5px;">Time</td><td style="border: 1px dashed black; padding: 5px;">'+r("date")(Date.now(),"yyyy-MM-dd HH:mm Z")+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">SPEC</td><td style="border: 1px dashed black; padding: 5px;">Platform: '+device.platform+", Version: "+device.version+", Manufacturer: "+device.manufacturer+", Model: "+device.model+", UUID: "+device.uuid+'</td></tr></tfoot><tbody><tr><td style="border: 1px dashed black; padding: 5px;">Name</td><td style="border: 1px dashed black; padding: 5px;">'+a.ctForm.ctName+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Email</td><td style="border: 1px dashed black; padding: 5px;">'+a.ctForm.ctEmail+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Message</td><td style="border: 1px dashed black; padding: 5px;">'+a.ctForm.ctMessage+"</td></tr></tbody></table>",text:"TEXT VERSION: "+a.ctForm.ctMessage};t.send(n,a.ctForm.ctName),a.ctForm={},a.forms.contactForm.$setPristine(),void 0!==typeof analytics&&analytics.trackEvent("Email","ContactUs")}}]),angular.module("fimex.directives",[]).directive("gpRadio",function(){return{restrict:"AE",require:"ngModel",scope:{model:"=ngModel",value:"=gpRadio"},link:function(e,t,a,n){t.addClass("button"),t.on("click",function(t){e.$apply(function(){n.$setViewValue(e.value)})}),e.$watch("model",function(a){t.removeClass("button-positive"),a===e.value&&t.addClass("button-positive")})}}}).directive("keyInput",function(){return function(e,t,a){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(a.keyInput)}),t.preventDefault())})}}).directive("keyboardHide",["$window",function(e){return{restrict:"A",link:function(t,a,n){angular.element(e).bind("native.keyboardshow",function(){a.addClass("hide")}),angular.element(e).bind("native.keyboardhide",function(){a.removeClass("hide")})}}}]).directive("keyboardHide4tabs",["$window",function(e){return{restrict:"A",link:function(t,a,n){angular.element(e).bind("native.keyboardshow",function(){a.addClass("tabs-item-hide")}),angular.element(e).bind("native.keyboardhide",function(){a.removeClass("tabs-item-hide")})}}}]),angular.module("fimex.filters",[]).filter("partRemove",["$sce",function(e){return function(t,a){var n=document.createElement("div");n.innerHTML=t;for(var o=n.getElementsByTagName(a),r=o.length;r>0;r--)o[r-1].parentNode.removeChild(o[r-1]);return e.trustAsHtml(n.outerHTML)}}]).filter("unicode",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("WPthumbnailURI",["$sce",function(e){return function(t){if(t&&t.length){var a=t.lastIndexOf("."),n="-150x150.";return e.trustAsResourceUrl(t.substring(0,a)+n+t.substring(a+1))}}}]).filter("unescapeHTML",function(){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return function(t){return angular.forEach(e,function(e,a){t=String(t).replace(new RegExp(e,"gi"),a)}),t}}),angular.module("fimex.notes",[]).factory("Notes",function(){var e=[{id:0,top:0,title:"NOTES_20160107_TITLE",content:"NOTES_20160107_CONTENT"},{id:1,top:0,title:"NOTES_20160108_TITLE",content:"NOTES_20160108_CONTENT"},{id:2,top:1,title:"NOTES_20160109_TITLE",content:"NOTES_20160109_CONTENT"},{id:3,top:0,title:"NOTES_20160211_TITLE",content:"NOTES_20160211_CONTENT"}];return{all:function(){return e},get:function(t){for(var a=0;a<e.length;a++)if(e[a].id===parseInt(t))return e[a];return null}}});